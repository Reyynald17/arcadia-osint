<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arcadia Admin | Command Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="../style.css">
    <script>
        // Proteksi Sesi Aktif
        if (sessionStorage.getItem("arcadia_auth") !== "authorized") {
            window.location.href = "login.html";
        }
    </script>
</head>
<body class="bg-black text-white min-h-screen font-sans">

    <nav class="border-b border-cyan-900 bg-black/50 p-6 flex justify-between items-center">
        <h1 class="font-bbh text-xl text-cyan-400 tracking-widest uppercase">Intelligence Dashboard</h1>
        <button onclick="logout()" class="text-xs border border-red-500 text-red-500 px-4 py-2 rounded-lg hover:bg-red-500 hover:text-white transition-all">TERMINATE SESSION</button>
    </nav>

    <main class="max-w-4xl mx-auto mt-12 px-6">
        <section class="border-2 border-cyan-400 rounded-[40px] p-8 bg-black shadow-[0_0_20px_rgba(34,211,238,0.1)]">
            <h2 class="font-bbh text-2xl mb-8 border-b border-gray-800 pb-4 uppercase">Broadcast New Intelligence</h2>
            
            <form id="newsForm" class="space-y-6">
                <div>
                    <label class="block text-xs font-bbh uppercase text-gray-500 mb-2">Operation Title</label>
                    <input type="text" id="title" required class="w-full bg-zinc-900 border border-gray-800 rounded-xl px-4 py-3 focus:border-cyan-400 outline-none transition-all">
                </div>

                <div>
                    <label class="block text-xs font-bbh uppercase text-gray-500 mb-2">Visual Asset (Upload to GitHub)</label>
                    <input type="file" id="imageFile" accept="image/*" required class="w-full bg-zinc-900 border border-gray-800 rounded-xl px-4 py-3 file:bg-cyan-500 file:border-none file:rounded-md file:px-4 file:py-1 file:mr-4 file:font-bbh cursor-pointer">
                </div>

                <div>
                    <label class="block text-xs font-bbh uppercase text-gray-500 mb-2">Intelligence Brief (Separate paragraphs with Enter)</label>
                    <textarea id="content" rows="6" required class="w-full bg-zinc-900 border border-gray-800 rounded-xl px-4 py-3 focus:border-cyan-400 outline-none transition-all"></textarea>
                </div>

                <button type="submit" id="submitBtn" class="w-full bg-cyan-500 text-black font-bbh py-4 rounded-xl hover:bg-cyan-400 transition-all font-bold uppercase tracking-widest">Deploy News</button>
            </form>
        </section>
    </main>

    <script>
        // CONFIGURATION (WAJIB DIISI)
        const GITHUB_CONFIG = {
            token: "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", // Token GitHub Anda
            owner: "Reyynald17",
            repo: "arcadia-osint",
            path: "assets/news/" // Folder tujuan di repo
        };

        const JSONBIN_CONFIG = {
            binId: "69538bcd43b1c97be90de1e6",
            apiKey: "$2a$10$M55GAQGmXXRYA96RdrzW.uAiqpU.X2JqBMvXOyp0dDkE.4zO/0dfa"
        };

        const newsForm = document.getElementById('newsForm');

        newsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerText = "UPLOADING ASSETS...";

            try {
                // 1. Upload Gambar ke GitHub
                const file = document.getElementById('imageFile').files[0];
                const fileName = `${Date.now()}-${file.name.replace(/\s/g, '_')}`;
                const base64Data = await toBase64(file);
                
                const ghResponse = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}${fileName}`, {
                    method: 'PUT',
                    headers: {
                        "Authorization": `Bearer ${GITHUB_CONFIG.token}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        message: `Archive Intelligence: ${fileName}`,
                        content: base64Data.split(',')[1]
                    })
                });

                const ghResult = await ghResponse.json();
                const imageUrl = ghResult.content.download_url; // URL Raw GitHub

                // 2. Ambil Data Lama dari JSONBin
                submitBtn.innerText = "UPDATING DATABASE...";
                const binRes = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_CONFIG.binId}/latest`, {
                    headers: { "X-Master-Key": JSONBIN_CONFIG.apiKey }
                });
                const binData = await binRes.json();
                let newsList = binData.record.news || [];

                // 3. Tambah Data Baru ke Daftar (Unshift untuk posisi paling atas)
                const newEntry = {
                    id: Date.now(),
                    title: document.getElementById('title').value,
                    image: imageUrl,
                    content: document.getElementById('content').value.split('\n').filter(p => p.trim() !== ""),
                    date: new Date().toLocaleDateString('en-GB')
                };
                newsList.unshift(newEntry);

                // 4. Update JSONBin
                await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_CONFIG.binId}`, {
                    method: 'PUT',
                    headers: {
                        "Content-Type": "application/json",
                        "X-Master-Key": JSONBIN_CONFIG.apiKey
                    },
                    body: JSON.stringify({ news: newsList })
                });

                alert("INTELLIGENCE DEPLOYED SUCCESSFULLY.");
                newsForm.reset();
            } catch (err) {
                console.error(err);
                alert("CRITICAL FAILURE DURING DEPLOYMENT.");
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerText = "DEPLOY NEWS";
            }
        });

        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });

        function logout() {
            sessionStorage.clear();
            window.location.href = "login.html";
        }
    </script>
</body>
</html>
